# CI Failure Analysis

The CI pipeline failed with 3 test failures in `tests/cli/commands/test_gh_tool.py`, all related to the new `gh-tool get-base-branch` command implementation. The failures reveal two distinct issues with the test setup and implementation interaction.

The first issue affects `test_get_base_branch_exit_code_error_api_failure` (line 340). This test expects the function to return exit code 2 when `list_pull_requests` raises an exception, but it returns 0 instead. The captured stdout shows a MagicMock object being printed rather than a branch name, indicating that the `_detect_from_pr` function is catching the exception internally (line 113 in gh_tool.py has a broad `except Exception` that returns None instead of propagating the error). When the exception is caught, the function continues to `_detect_from_issue` and `_detect_default_branch`, and since `mock_default` isn't configured to return None in this test, it returns a MagicMock object which is truthy, causing success. The test needs to also mock `get_default_branch_name` to return None to ensure the error path is tested, OR the implementation needs to re-raise certain exceptions from PR detection to trigger the exit code 2 path.

The second issue affects both `test_gh_tool_get_base_branch_command_calls_function` (line 508) and `test_gh_tool_get_base_branch_with_project_dir_option` (line 531). These tests patch `execute_get_base_branch` but the actual function still runs because the patching happens after the module is imported. The tests call `main()` which triggers CLI parsing and the real `execute_get_base_branch` function execution before the mock takes effect. In `test_gh_tool_get_base_branch_command_calls_function`, the real function runs without proper mocks, finds no GitHub token, and returns exit code 1 (detection failure). In `test_gh_tool_get_base_branch_with_project_dir_option`, the real function validates `/custom/path` doesn't exist via `resolve_project_dir`, raising a ValueError that results in exit code 2.

The files requiring changes are `tests/cli/commands/test_gh_tool.py` (all three failing tests) and potentially `src/mcp_coder/cli/commands/gh_tool.py` if the error propagation behavior needs adjustment. The test fixes should ensure proper mock isolation by either patching at the right import path, using `autospec=True`, or restructuring the tests to call `execute_get_base_branch` directly rather than going through `main()`. For the API failure test, the mock configuration needs to ensure all fallback paths also fail to properly test the error exit code.
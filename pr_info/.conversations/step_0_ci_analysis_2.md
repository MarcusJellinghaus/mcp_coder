# CI Failure Analysis

The unit test `test_full_session_lifecycle_status_01_to_04` is failing with an assertion error. The test expects the operation `"prepare_branch:status-04:plan-review"` to be present in the operations list, but the actual operations list only contains `['launch_vscode']`. This indicates that the `_prepare_restart_branch` function is not being called during the test execution, or the mocked function is not recording its calls properly.

The CI log shows a warning message "Failed to regenerate files for issue #100: GitHub token not found. Configure it in ~/.mcp_coder/config.toml or set GITHUB_TOKEN environment variable". This suggests the test is attempting to create real `IssueManager` and `IssueBranchManager` objects instead of using the mocked versions. The test sets up mocks for these managers, but the implementation in `restart_closed_sessions` is likely creating them before the branch preparation logic runs, causing the GitHub token error and potentially preventing `_prepare_restart_branch` from being called.

The root cause appears to be in `src/mcp_coder/workflows/vscodeclaude/orchestrator.py` in the `restart_closed_sessions` function. The function needs to properly initialize the mocked `IssueManager` and `IssueBranchManager` objects early enough in the restart flow so that `_prepare_restart_branch` can be called with the correct branch manager instance. The test mocks these managers at line 1663-1671 but the mocks may not be intercepting the actual instantiation that happens during the restart process.

Files that need changes include `tests/workflows/vscodeclaude/test_orchestrator_sessions.py` (the failing test) and potentially `src/mcp_coder/workflows/vscodeclaude/orchestrator.py` (the implementation). The fix likely requires either adjusting how the test mocks the manager creation or adjusting when managers are instantiated in the restart flow to ensure the branch preparation logic runs with the properly mocked dependencies.
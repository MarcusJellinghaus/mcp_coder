# CI Failure Analysis

The CI integration tests failed with 4 test failures related to git branch naming inconsistency between "main" and "master". The `git_repo_with_remote` fixture in `tests/utils/git_operations/conftest.py` creates repositories with the default branch renamed to "main" (via `repo.git.branch("-M", "main")`), but three tests in `tests/utils/git_operations/test_remotes.py` (`test_git_push_default_no_force`, `test_git_push_force_with_lease_after_rebase`, and `test_git_push_force_with_lease_fails_on_unexpected_remote`) attempt to push to "origin master" instead of "origin main". This causes the error `error: src refspec master does not match any` because no "master" branch exists.

The fourth failure is in `tests/utils/git_operations/test_branches.py` (`test_needs_rebase_behind`) where the `needs_rebase()` function returns `False` instead of the expected `True`. This is likely related to the same branch naming issue or a logic bug in the `needs_rebase()` function in `src/mcp_coder/utils/git_operations/branches.py`. The function uses `git merge-base --is-ancestor HEAD origin/target` to check if the current branch is up-to-date, but the logic may not correctly detect when the current branch is behind when both branches have diverged (the current branch is not an ancestor but also not ahead).

The fix requires updating the three failing tests in `test_remotes.py` to use "main" instead of "master" when pushing to the remote (lines 68, 89, and 123). For the `test_needs_rebase_behind` failure, the `needs_rebase()` function logic needs review - when `merge-base --is-ancestor` fails, it means HEAD is not an ancestor of origin/target, but this doesn't necessarily mean the branch is behind; it could mean the branches have diverged. The function should check if origin/target contains commits not in HEAD, which it attempts to do with `rev-list --count HEAD..origin/target`, but the test scenario may not be setting up the expected divergent state correctly.
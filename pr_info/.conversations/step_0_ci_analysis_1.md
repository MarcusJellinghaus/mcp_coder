# CI Failure Analysis

The CI `file-size` job failed because `tests/cli/commands/test_prompt.py` now contains 801 lines, exceeding the 750-line limit enforced by `mcp-coder check file-size`. This file is not present in `.large-files-allowlist`, so the check exits with code 1 and blocks the pipeline.

The file grew as a direct result of Step 6 of the implementation plan (see `pr_info/steps/step_6.md`). Step 6 requires updating `tests/cli/commands/test_prompt.py` to replace mocks of `ask_llm` and `ask_claude_code_api_detailed_sync` with mocks of `prompt_llm`, and to restructure test data so that `prompt_llm` returns a full `LLMResponseDict` (including a `raw_response` sub-dict). These changes add new fixture setup and updated assertions across multiple test classes (`TestFormatVerboseResponse`, `TestFormatRawResponse`, `TestBasicPrompt`, etc.), pushing the file past the 750-line threshold.

The `unit-tests` job also failed, which is consistent with Step 6 being partially or not yet implemented: the tests in `test_prompt.py` were updated to expect the new `prompt_llm`-based interface, but `src/mcp_coder/cli/commands/prompt.py` may not yet have been migrated away from `ask_llm` and `ask_claude_code_api_detailed_sync`, causing the mocks to not match and tests to fail.

Two changes are needed to resolve both failures. First, the implementation in `src/mcp_coder/cli/commands/prompt.py` must be completed so that the just-text and verbose/raw branches use `prompt_llm()` and pass `LLMResponseDict` directly to `store_session()`, making the updated tests pass. Second, once the test file size cannot be reduced below 750 lines without splitting the file, `tests/cli/commands/test_prompt.py` must be added to `.large-files-allowlist` so the file-size check passes â€” or alternatively the test file should be split into smaller focused modules (e.g. separating verbose/raw tests from just-text tests) to bring each file under the limit without modifying the allowlist.
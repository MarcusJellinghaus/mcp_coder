# CI Failure Analysis

The CI pipeline failed with 25 unit test failures, all related to the implementation of git merge-base detection for PR creation (Issue #388). The failures fall into two categories:

The first category involves 8 tests in `tests/workflow_utils/test_base_branch.py` under the `TestDetectFromGitMergeBase` class. These tests fail with "AttributeError: 'dict' object attribute '__iter__' is read-only". This error occurs because the mock setup for `repo.heads` uses a dictionary directly, but the test code then tries to override `__iter__` on that dictionary instance (e.g., `mock_repo.heads.__iter__ = lambda self: iter([...])`) which is not allowed on dict objects. The mocking approach needs to be fixed to use a proper MagicMock object for `repo.heads` instead of a dictionary, allowing the `__iter__` method to be customized.

The second category involves 17 tests across `tests/workflows/create_pr/test_generation.py` and `tests/workflows/create_pr/test_repository.py`. The test_repository.py tests fail because they attempt to mock `mcp_coder.workflows.create_pr.core.get_parent_branch_name`, but this function was removed as part of the implementation (replaced by `detect_base_branch()`). These tests need to be updated to mock `detect_base_branch` instead. The test_generation.py tests fail because `generate_pr_summary()` now calls `detect_base_branch()` internally before calling `get_branch_diff()`, but the tests don't mock this new dependency. When `detect_base_branch()` returns `None` (due to unmocked git operations), the function returns early with a fallback message "Could not generate summary - base branch unknown" instead of proceeding to call the mocked `get_branch_diff()`, `get_prompt()`, and `ask_llm()` functions.

The fix requires: (1) updating `TestDetectFromGitMergeBase` tests to use MagicMock for `repo.heads` instead of a dict, (2) updating `TestCreatePullRequest` tests to mock `detect_base_branch` instead of the removed `get_parent_branch_name`, and (3) updating `TestGeneratePrSummary` tests to mock `detect_base_branch` to return a valid branch name so the function proceeds to call the other mocked dependencies.
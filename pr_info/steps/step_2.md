# Step 2: Implement `ignore_files` Parameter and Update Callers

## Reference
- **Summary**: `pr_info/steps/summary.md`
- **Step 1**: `pr_info/steps/step_1.md` (tests)
- **Issue**: #254 - Ignore uv.lock in is_working_directory_clean() check

---

## LLM Prompt

```
Implement Step 2 from pr_info/steps/step_2.md for Issue #254.

1. Add `ignore_files` parameter to `is_working_directory_clean()` function
2. Update all 4 caller locations to pass `ignore_files=["uv.lock"]`
3. Remove `uv.lock` from `.gitignore`

This should make the tests from Step 1 pass.

Reference: pr_info/steps/summary.md for full context.
```

---

## Part A: Modify `is_working_directory_clean()` Function

### WHERE
```
src/mcp_coder/utils/git_operations/repository.py
```

### WHAT: Updated Function Signature
```python
def is_working_directory_clean(
    project_dir: Path, 
    ignore_files: list[str] | None = None
) -> bool:
```

### ALGORITHM: Core Logic (6 lines)
```python
ignore_set = set(ignore_files) if ignore_files else set()
status = get_full_status(project_dir)
staged = [f for f in status["staged"] if f not in ignore_set]
modified = [f for f in status["modified"] if f not in ignore_set]
untracked = [f for f in status["untracked"] if f not in ignore_set]
return len(staged) + len(modified) + len(untracked) == 0
```

### DATA: Docstring Update
```python
"""
Check if working directory has no uncommitted changes.

Args:
    project_dir: Path to the project directory containing git repository
    ignore_files: Optional list of filenames to ignore (exact match only).
                  Useful for excluding build artifacts like 'uv.lock'.

Returns:
    True if no staged, modified, or untracked files exist 
    (excluding ignored files), False otherwise

Raises:
    ValueError: If the directory is not a git repository
"""
```

---

## Part B: Update Caller Locations

### Caller 1: `create_plan.py`

**WHERE**: `src/mcp_coder/workflows/create_plan.py` (line ~71)

**WHAT**: Inside `check_prerequisites()` function

**HOW**: Change from:
```python
if not is_working_directory_clean(project_dir):
```
To:
```python
if not is_working_directory_clean(project_dir, ignore_files=["uv.lock"]):
```

---

### Caller 2: `prerequisites.py`

**WHERE**: `src/mcp_coder/workflows/implement/prerequisites.py` (line ~44)

**WHAT**: Inside `check_git_clean()` function

**HOW**: Change from:
```python
is_clean = is_working_directory_clean(project_dir)
```
To:
```python
is_clean = is_working_directory_clean(project_dir, ignore_files=["uv.lock"])
```

---

### Caller 3: `core.py` (first location)

**WHERE**: `src/mcp_coder/workflows/create_pr/core.py` (line ~247)

**WHAT**: Inside `check_prerequisites()` function

**HOW**: Change from:
```python
if not is_working_directory_clean(project_dir):
```
To:
```python
if not is_working_directory_clean(project_dir, ignore_files=["uv.lock"]):
```

---

### Caller 4: `core.py` (second location)

**WHERE**: `src/mcp_coder/workflows/create_pr/core.py` (line ~592)

**WHAT**: Inside `run_create_pr_workflow()` function

**HOW**: Change from:
```python
if not is_working_directory_clean(project_dir):
```
To:
```python
if not is_working_directory_clean(project_dir, ignore_files=["uv.lock"]):
```

---

## Part C: Remove `.gitignore` Workaround

### WHERE
```
.gitignore
```

### WHAT: Remove these 2 lines at end of file
```
# UV lock file (generated by mcp-coder environment, not target projects)
uv.lock
```

---

## Verification Commands

```bash
# Run new tests (should pass)
pytest tests/utils/git_operations/test_repository.py -v -k "ignore_files" -m git_integration

# Run all repository tests (backward compatibility)
pytest tests/utils/git_operations/test_repository.py -v -m git_integration

# Run full test suite
pytest -m "not claude_cli_integration and not claude_api_integration and not github_integration"
```

---

## Checklist
- [ ] `is_working_directory_clean()` accepts `ignore_files` parameter
- [ ] Docstring updated with new parameter documentation
- [ ] `create_plan.py` updated
- [ ] `implement/prerequisites.py` updated  
- [ ] `create_pr/core.py` updated (2 locations)
- [ ] `uv.lock` removed from `.gitignore`
- [ ] All tests pass

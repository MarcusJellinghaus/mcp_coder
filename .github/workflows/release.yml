name: Release

on:
  push:
    tags:
      - 'v*'  # Trigger on any tag starting with 'v' (e.g., v1.0.0, v2.1.0-rc1)

permissions:
  contents: write  # Required for creating releases

jobs:
  validate-version:
    name: Validate Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install package
        run: |
          python -m pip install --upgrade pip
          python -m pip install .

      - name: Validate tag matches package version
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Tag: $TAG"

          # Use Python to validate version match
          python -c "
          import sys
          from mcp_coder.utils.version import validate_tag_version, get_package_version

          tag = '$TAG'
          print(f'Validating tag: {tag}')

          try:
              package_version = get_package_version()
              print(f'Package version: {package_version}')
              validate_tag_version(tag, package_version)
              print('✅ Version validation passed!')
          except Exception as e:
              print(f'❌ Version validation failed: {e}')
              sys.exit(1)
          "

  build:
    name: Build Distribution
    needs: validate-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install build wheel

      - name: Build distribution
        run: python -m build

      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: dist
          path: dist/

  test:
    name: Run Tests
    needs: validate-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install .
          python -m pip install .[dev]

      - name: Run unit tests
        run: |
          pytest -m "not git_integration and not claude_cli_integration and not claude_api_integration and not formatter_integration and not github_integration and not jenkins_integration" --junitxml=unit-tests.xml

      - name: Run type checking
        run: |
          mypy --strict src tests

  release:
    name: Create Release
    needs: [validate-version, build, test]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: dist
          path: dist/

      - name: Determine if prerelease
        id: prerelease
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "Tag: $TAG"

          # Check if tag contains prerelease indicators
          if [[ "$TAG" =~ -(rc|alpha|beta) ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
            echo "This is a prerelease"
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
            echo "This is a stable release"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
          prerelease: ${{ steps.prerelease.outputs.prerelease }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # PyPI publishing is commented out by default
  # Uncomment and configure when ready to publish to PyPI
  #
  # publish-pypi:
  #   name: Publish to PyPI
  #   needs: [validate-version, build, test]
  #   runs-on: ubuntu-latest
  #   # Only publish stable releases to PyPI (not prereleases)
  #   if: "!contains(github.ref, '-rc') && !contains(github.ref, '-alpha') && !contains(github.ref, '-beta')"
  #   steps:
  #     - name: Download artifacts
  #       uses: actions/download-artifact@v3
  #       with:
  #         name: dist
  #         path: dist/
  #
  #     - name: Publish to PyPI
  #       uses: pypa/gh-action-pypi-publish@release/v1
  #       with:
  #         password: ${{ secrets.PYPI_API_TOKEN }}

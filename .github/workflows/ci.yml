name: Python CI

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  check-forbidden-folders:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
    - uses: actions/checkout@v4
    
    - name: Check for forbidden folders in PR
      run: |
        echo "üîç Checking PR for forbidden folders..."
        
        # Function to check for folder existence case-insensitively
        check_forbidden_folder() {
          local pattern="$1"
          
          if find . -type d -ipath "*${pattern}*" -print -quit | grep -q .; then
            echo "‚ùå Found forbidden folder: ${pattern}"
            find . -type d -ipath "*${pattern}*" | sed 's/^/   /'
            return 1
          else
            echo "‚úÖ ${pattern} - OK"
            return 0
          fi
        }
        
        ERROR=0
        check_forbidden_folder "pr_info/steps" || ERROR=1
        check_forbidden_folder "pr_info/.conversations" || ERROR=1
        
        if [ $ERROR -eq 1 ]; then
          echo ""
          echo "‚ùå PR BLOCKED: Remove forbidden folders and push again."
          echo "üí° These folders are only blocked in PRs, not regular commits."
          exit 1
        else
          echo "üéâ All checks passed!"
        fi

  test:
    runs-on: ubuntu-latest
    needs: [check-forbidden-folders]
    if: always() && (github.event_name != 'pull_request' || needs.check-forbidden-folders.result == 'success')
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install .
        python -m pip install .[dev]
        
    - name: Check formatting with black
      id: black
      run: black --check src tests
      continue-on-error: true
        
    - name: Check imports with isort
      id: isort
      run: isort --check --profile=black --float-to-top src tests
      continue-on-error: true
        
    - name: Check for errors with pylint
      id: pylint
      run: pylint -E ./src ./tests
      continue-on-error: true
        
    - name: Run unit tests (fast)
      id: unit-tests
      run: pytest -m "not git_integration and not claude_integration"
      continue-on-error: true
        
    - name: Run integration tests
      id: integration-tests
      run: pytest -m "git_integration or claude_integration"
      continue-on-error: true
        
    - name: Check type hints with mypy
      id: mypy
      run: mypy --strict src tests
      continue-on-error: true
      
    - name: Summarize results
      if: always()
      run: |
        echo "CI checks completed. Review logs for any errors or warnings."
        
        ERROR=0
        [[ "${{ steps.black.outcome }}" == "failure" ]] && { echo "‚ùå Black formatting check failed"; ERROR=1; } || echo "‚úÖ Black formatting check passed"
        [[ "${{ steps.isort.outcome }}" == "failure" ]] && { echo "‚ùå isort import check failed"; ERROR=1; } || echo "‚úÖ isort import check passed"
        [[ "${{ steps.pylint.outcome }}" == "failure" ]] && { echo "‚ùå pylint error check failed"; ERROR=1; } || echo "‚úÖ pylint error check passed"
        [[ "${{ steps.unit-tests.outcome }}" == "failure" ]] && { echo "‚ùå unit tests failed"; ERROR=1; } || echo "‚úÖ unit tests passed"
        [[ "${{ steps.integration-tests.outcome }}" == "failure" ]] && { echo "‚ùå integration tests failed"; ERROR=1; } || echo "‚úÖ integration tests passed"
        [[ "${{ steps.mypy.outcome }}" == "failure" ]] && { echo "‚ùå mypy type checking failed"; ERROR=1; } || echo "‚úÖ mypy type checking passed"
        
        exit $ERROR
